name: deploy-pokemon-prod

on:
  workflow_dispatch:
    inputs:
      image_ref:
        description: "Image to deploy: full ref, or just tag (latest / sha-<commit>). Empty defaults to latest."
        required: false
        default: "latest"
        type: string
      deploy_root:
        description: "Absolute path to the Go repo on prod runner"
        required: false
        default: "/media/adam/storage/Code/Go"
        type: string
      service_name:
        description: "Compose service to deploy"
        required: false
        default: "pokemon_data"
        type: string

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy Pokemon To Prod
    runs-on: [self-hosted, linux, x64, prod]
    environment: production
    concurrency:
      group: deploy-pokemon-prod
      cancel-in-progress: false

    steps:
      - name: Sync Deploy Repo
        shell: bash
        run: |
          set -euo pipefail

          DEPLOY_ROOT="${{ inputs.deploy_root }}"
          DEPLOY_REF="${{ github.ref_name }}"

          if [[ ! -d "${DEPLOY_ROOT}/.git" ]]; then
            echo "Deploy root is not a git repo: ${DEPLOY_ROOT}" >&2
            exit 1
          fi

          if [[ -n "$(git -C "${DEPLOY_ROOT}" status --porcelain)" ]]; then
            echo "Deploy root has local uncommitted changes: ${DEPLOY_ROOT}" >&2
            echo "Commit/stash/revert local changes before using automated deploy." >&2
            exit 1
          fi

          echo "Syncing ${DEPLOY_ROOT} to origin/${DEPLOY_REF}"
          git -C "${DEPLOY_ROOT}" fetch --prune origin
          git -C "${DEPLOY_ROOT}" checkout "${DEPLOY_REF}"
          git -C "${DEPLOY_ROOT}" pull --ff-only origin "${DEPLOY_REF}"

      - name: Preflight Checks
        shell: bash
        run: |
          set -euo pipefail

          DEPLOY_ROOT="${{ inputs.deploy_root }}"
          COMPOSE_FILE="${DEPLOY_ROOT}/pokemon/docker-compose.yml"
          ENV_FILE="${DEPLOY_ROOT}/pokemon/.env"
          NEW_DB_DIR="${DEPLOY_ROOT}/pokemon/data"
          OLD_DB_DIR="${DEPLOY_ROOT}/pokemon_data/data"
          DB_FILE="pokego.db"
          EDGE_NETWORK="pokemon_edge"
          EDGE_SUBNET="172.30.0.0/24"
          EDGE_GATEWAY="172.30.0.1"

          if [[ ! -d "${DEPLOY_ROOT}" ]]; then
            echo "Deploy root not found: ${DEPLOY_ROOT}" >&2
            exit 1
          fi

          if [[ ! -f "${COMPOSE_FILE}" ]]; then
            echo "Compose file not found: ${COMPOSE_FILE}" >&2
            exit 1
          fi

          if [[ ! -f "${ENV_FILE}" ]]; then
            echo "Env file not found: ${ENV_FILE}" >&2
            exit 1
          fi

          mkdir -p "${NEW_DB_DIR}"
          if [[ ! -f "${NEW_DB_DIR}/${DB_FILE}" && -f "${OLD_DB_DIR}/${DB_FILE}" ]]; then
            echo "Seeding pokemon SQLite DB from ${OLD_DB_DIR}/${DB_FILE}"
            cp "${OLD_DB_DIR}/${DB_FILE}" "${NEW_DB_DIR}/${DB_FILE}"
            [[ -f "${OLD_DB_DIR}/${DB_FILE}-wal" ]] && cp "${OLD_DB_DIR}/${DB_FILE}-wal" "${NEW_DB_DIR}/${DB_FILE}-wal" || true
            [[ -f "${OLD_DB_DIR}/${DB_FILE}-shm" ]] && cp "${OLD_DB_DIR}/${DB_FILE}-shm" "${NEW_DB_DIR}/${DB_FILE}-shm" || true
          fi

          if ! docker network inspect "${EDGE_NETWORK}" >/dev/null 2>&1; then
            echo "External docker network ${EDGE_NETWORK} not found; creating it now."
            docker network create \
              --driver bridge \
              --subnet "${EDGE_SUBNET}" \
              --gateway "${EDGE_GATEWAY}" \
              "${EDGE_NETWORK}"
          fi

          NETWORK_SUBNET="$(docker network inspect -f '{{(index .IPAM.Config 0).Subnet}}' "${EDGE_NETWORK}")"
          if [[ "${NETWORK_SUBNET}" != "${EDGE_SUBNET}" ]]; then
            echo "Network ${EDGE_NETWORK} exists but subnet is ${NETWORK_SUBNET}; expected ${EDGE_SUBNET}." >&2
            exit 1
          fi

          docker compose -f "${COMPOSE_FILE}" --env-file "${ENV_FILE}" config >/dev/null

      - name: Deploy With Health Check And Rollback
        shell: bash
        run: |
          set -euo pipefail

          DEPLOY_ROOT="${{ inputs.deploy_root }}"
          SERVICE_NAME="${{ inputs.service_name }}"
          IMAGE_REPO="adamwentworth/pokemon_service_go"
          RAW_IMAGE_INPUT="${{ inputs.image_ref }}"
          TARGET_IMAGE=""
          COMPOSE_FILE="${DEPLOY_ROOT}/pokemon/docker-compose.yml"
          ENV_FILE="${DEPLOY_ROOT}/pokemon/.env"
          DATA_DIR="${DEPLOY_ROOT}/pokemon/data"
          CONTAINER_NAME="pokemon_data_container"
          COMPOSE_PROJECT_NAME="pokemon"

          # Accept either:
          # - full ref: adamwentworth/pokemon_service_go:sha-abc...
          # - bare tag: latest or sha-abc...
          # - accidental ":latest" (treated as latest on IMAGE_REPO)
          if [[ -z "${RAW_IMAGE_INPUT}" ]]; then
            TARGET_IMAGE="${IMAGE_REPO}:latest"
          elif [[ "${RAW_IMAGE_INPUT}" == :* ]]; then
            TARGET_IMAGE="${IMAGE_REPO}${RAW_IMAGE_INPUT}"
          elif [[ "${RAW_IMAGE_INPUT}" == */* ]]; then
            TARGET_IMAGE="${RAW_IMAGE_INPUT}"
          else
            TARGET_IMAGE="${IMAGE_REPO}:${RAW_IMAGE_INPUT}"
          fi

          # If full ref omitted tag/digest, default to latest.
          if [[ "${TARGET_IMAGE}" == */* && "${TARGET_IMAGE}" != *:* && "${TARGET_IMAGE}" != *@* ]]; then
            TARGET_IMAGE="${TARGET_IMAGE}:latest"
          fi

          PREVIOUS_IMAGE="$(docker inspect --format '{{.Config.Image}}' "${CONTAINER_NAME}" 2>/dev/null || true)"
          if [[ -n "${PREVIOUS_IMAGE}" ]]; then
            echo "Previous image: ${PREVIOUS_IMAGE}"
          else
            echo "No existing container image found for ${CONTAINER_NAME}; rollback image will be unavailable."
          fi

          echo "Pulling target image: ${TARGET_IMAGE}"
          docker pull "${TARGET_IMAGE}"

          # Ensure the bind-mounted SQLite directory is writable by the image runtime user.
          APP_UID="$(docker run --rm --entrypoint /bin/sh "${TARGET_IMAGE}" -c 'id -u app 2>/dev/null || id -u')"
          APP_GID="$(docker run --rm --entrypoint /bin/sh "${TARGET_IMAGE}" -c 'id -g app 2>/dev/null || id -g')"
          echo "Preparing ${DATA_DIR} for container uid:gid ${APP_UID}:${APP_GID}"

          mkdir -p "${DATA_DIR}"
          docker run --rm -v "${DATA_DIR}:/data" alpine:3.20 sh -ec "
            mkdir -p /data
            chown -R ${APP_UID}:${APP_GID} /data || true
            find /data -type d -exec chmod 775 {} +
            find /data -type f -exec chmod 664 {} +
          "

          if ! docker run --rm --user "${APP_UID}:${APP_GID}" -v "${DATA_DIR}:/data" alpine:3.20 sh -ec 'touch /data/.write_test && rm -f /data/.write_test'; then
            echo "Data directory is not writable for runtime uid:gid ${APP_UID}:${APP_GID}: ${DATA_DIR}" >&2
            exit 1
          fi

          # If an existing container with the same fixed name was created by another
          # compose project (for example old node pokemon_data stack), remove it first.
          EXISTING_PROJECT="$(docker inspect --format '{{ index .Config.Labels "com.docker.compose.project" }}' "${CONTAINER_NAME}" 2>/dev/null || true)"
          if [[ -n "${EXISTING_PROJECT}" && "${EXISTING_PROJECT}" != "${COMPOSE_PROJECT_NAME}" ]]; then
            echo "Removing existing ${CONTAINER_NAME} from compose project ${EXISTING_PROJECT} before deploy."
            docker rm -f "${CONTAINER_NAME}"
          fi

          echo "Deploying ${SERVICE_NAME} with image ${TARGET_IMAGE}"
          POKEMON_IMAGE="${TARGET_IMAGE}" docker compose \
            -f "${COMPOSE_FILE}" \
            --env-file "${ENV_FILE}" \
            up -d --no-deps --force-recreate "${SERVICE_NAME}"

          CONTAINER_IP="$(docker inspect -f '{{with index .NetworkSettings.Networks "pokemon_edge"}}{{.IPAddress}}{{end}}' "${CONTAINER_NAME}" 2>/dev/null || true)"
          if [[ -z "${CONTAINER_IP}" ]]; then
            echo "Failed to determine container IP on pokemon_edge for ${CONTAINER_NAME}" >&2
            docker logs --tail 200 "${CONTAINER_NAME}" || true
            exit 1
          fi

          echo "Waiting for /readyz on ${CONTAINER_IP}:3001"
          HEALTH_OK=0
          for _ in $(seq 1 30); do
            if curl -fsS --max-time 2 "http://${CONTAINER_IP}:3001/readyz" >/dev/null 2>&1; then
              HEALTH_OK=1
              break
            fi
            sleep 2
          done

          if [[ "${HEALTH_OK}" -ne 1 ]]; then
            echo "New deployment failed readiness checks." >&2
            echo "Container status:"
            docker ps -a --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}" || true
            echo "Recent container logs:"
            docker logs --tail 200 "${CONTAINER_NAME}" || true
            echo "Current /readyz payload (if reachable):"
            curl -sS --max-time 3 "http://${CONTAINER_IP}:3001/readyz" || true
            if [[ -n "${PREVIOUS_IMAGE}" ]]; then
              echo "Rolling back to ${PREVIOUS_IMAGE}"
              POKEMON_IMAGE="${PREVIOUS_IMAGE}" docker compose \
                -f "${COMPOSE_FILE}" \
                --env-file "${ENV_FILE}" \
                up -d --no-deps --force-recreate "${SERVICE_NAME}"
            else
              echo "Rollback skipped: previous image not found." >&2
              echo "Manual rollback option: deploy adamwentworth/pokemon_data:latest"
            fi
            exit 1
          fi

          echo "Deployment succeeded."
